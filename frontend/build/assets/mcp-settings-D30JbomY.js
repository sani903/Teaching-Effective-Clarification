import{p as t,R as K,w as H,r as M}from"./chunk-NISHYRIK-CgksP-ke.js";import{u as j,S as L}from"./use-settings-y2Eq7ITW.js";import{u as F}from"./open-hands-axios-DsgPCc-0.js";import{u as q,B as U}from"./brand-button-BLaTuvKj.js";import{I as n}from"./declaration-BLNM_M5s.js";import{e as X,f as Z}from"./index-CQq-b-9n.js";import{u as P}from"./useTranslation-BhtO8iYN.js";import{S as R}from"./settings-input-Blv1eH9r.js";import{S as J}from"./settings-dropdown-input-DCArA_yj.js";import{O as B}from"./optional-tag-C2att6n-.js";import{c as k}from"./utils-C5iw9p3M.js";import{C as W}from"./confirmation-modal-LYfE9har.js";import"./use-config-BtaDlBUv.js";import"./option-service.api-L97_35Hu.js";import"./module-CWLbpm_7.js";import"./use-is-authed-CJdzFdqm.js";import"./chunk-S6H5EOGR-BBckzTk7.js";import"./useSingleSelectListState-D8PQAT0i.js";import"./index-BBSevn_K.js";import"./preload-helper-BhQ1_4_d.js";import"./modal-backdrop-CfHRd2ER.js";function tt(){const c=F(),{data:d}=j();return q({mutationFn:async a=>{if(!d?.MCP_CONFIG)return;const i={...d.MCP_CONFIG},[u,s]=a.split("-"),r=parseInt(s,10);u==="sse"?i.sse_servers.splice(r,1):u==="stdio"?i.stdio_servers.splice(r,1):u==="shttp"&&i.shttp_servers.splice(r,1);const E={mcp_config:i};await L.saveSettings(E)},onSuccess:()=>{c.invalidateQueries({queryKey:["settings"]})}})}function et(){const c=F(),{data:d}=j();return q({mutationFn:async a=>{if(!d)return;const u={...d.MCP_CONFIG||{sse_servers:[],stdio_servers:[],shttp_servers:[]}};if(a.type==="sse"){const r={url:a.url,...a.api_key&&{api_key:a.api_key}};u.sse_servers.push(r)}else if(a.type==="stdio"){const r={name:a.name,command:a.command,...a.args&&{args:a.args},...a.env&&{env:a.env}};u.stdio_servers.push(r)}else if(a.type==="shttp"){const r={url:a.url,...a.api_key&&{api_key:a.api_key},...a.timeout!==void 0&&{timeout:a.timeout}};u.shttp_servers.push(r)}const s={mcp_config:u};await L.saveSettings(s)},onSuccess:()=>{c.invalidateQueries({queryKey:["settings"]})}})}function st(){const c=F(),{data:d}=j();return q({mutationFn:async({serverId:a,server:i})=>{if(!d?.MCP_CONFIG)return;const u={...d.MCP_CONFIG},[s,r]=a.split("-"),E=parseInt(r,10);if(s==="sse"){const x={url:i.url,...i.api_key&&{api_key:i.api_key}};u.sse_servers[E]=x}else if(s==="stdio"){const x={name:i.name,command:i.command,...i.args&&{args:i.args},...i.env&&{env:i.env}};u.stdio_servers[E]=x}else if(s==="shttp"){const x={url:i.url,...i.api_key&&{api_key:i.api_key},...i.timeout!==void 0&&{timeout:i.timeout}};u.shttp_servers[E]=x}const m={mcp_config:u};await L.saveSettings(m)},onSuccess:()=>{c.invalidateQueries({queryKey:["settings"]})}})}function nt({server:c,onEdit:d,onDelete:a}){const{t:i}=P(),u=m=>{switch(m){case"sse":return i(n.SETTINGS$MCP_SERVER_TYPE_SSE);case"stdio":return i(n.SETTINGS$MCP_SERVER_TYPE_STDIO);case"shttp":return i(n.SETTINGS$MCP_SERVER_TYPE_SHTTP);default:return m.toUpperCase()}},s=m=>{if(m.type==="stdio"){if(m.command){const x=m.args&&m.args.length>0?` ${m.args.join(" ")}`:"";return`${m.command}${x}`}return m.name||""}return(m.type==="sse"||m.type==="shttp")&&m.url?m.url:""},r=c.type==="stdio"?c.name:c.url,E=s(c);return t.jsxs("tr",{"data-testid":"mcp-server-item",className:"grid grid-cols-[minmax(0,0.25fr)_120px_minmax(0,1fr)_120px] gap-4 items-start border-t border-tertiary",children:[t.jsx("td",{className:"p-3 text-sm text-content-2 truncate min-w-0",title:r,children:r}),t.jsx("td",{className:"p-3 text-sm text-content-2 whitespace-nowrap",children:u(c.type)}),t.jsx("td",{className:"p-3 text-sm text-content-2 opacity-80 italic min-w-0 truncate",title:E,children:t.jsx("span",{className:"inline-block max-w-full align-bottom",children:E})}),t.jsxs("td",{className:"p-3 flex items-start justify-end gap-4 whitespace-nowrap",children:[t.jsx("button",{"data-testid":"edit-mcp-server-button",type:"button",onClick:d,"aria-label":`Edit ${r}`,className:"cursor-pointer hover:text-content-1 transition-colors",children:t.jsx(X,{size:16})}),t.jsx("button",{"data-testid":"delete-mcp-server-button",type:"button",onClick:a,"aria-label":`Delete ${r}`,className:"cursor-pointer hover:text-content-1 transition-colors",children:t.jsx(Z,{size:16})})]})]})}function rt({servers:c,onEdit:d,onDelete:a}){const{t:i}=P();return c.length===0?t.jsx("div",{className:"border border-tertiary rounded-md p-8 text-center",children:t.jsx("p",{className:"text-content-2 text-sm",children:i(n.SETTINGS$MCP_NO_SERVERS)})}):t.jsx("div",{className:"border border-tertiary rounded-md overflow-hidden",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"bg-base-tertiary",children:t.jsxs("tr",{className:"grid grid-cols-[minmax(0,0.25fr)_120px_minmax(0,1fr)_120px] gap-4 items-start",children:[t.jsx("th",{className:"text-left p-3 text-sm font-medium",children:i(n.SETTINGS$NAME)}),t.jsx("th",{className:"text-left p-3 text-sm font-medium",children:i(n.SETTINGS$MCP_SERVER_TYPE)}),t.jsx("th",{className:"text-left p-3 text-sm font-medium",children:i(n.SETTINGS$MCP_SERVER_DETAILS)}),t.jsx("th",{className:"text-right p-3 text-sm font-medium",children:i(n.SETTINGS$ACTIONS)})]})}),t.jsx("tbody",{children:c.map(u=>t.jsx(nt,{server:u,onEdit:()=>d(u),onDelete:()=>a(u.id)},u.id))})]})})}function Q({mode:c,server:d,existingServers:a,onSubmit:i,onCancel:u}){const{t:s}=P(),[r,E]=K.useState(d?.type||"sse"),[m,x]=K.useState(null),v=[{key:"sse",label:s(n.SETTINGS$MCP_SERVER_TYPE_SSE)},{key:"stdio",label:s(n.SETTINGS$MCP_SERVER_TYPE_STDIO)},{key:"shttp",label:s(n.SETTINGS$MCP_SERVER_TYPE_SHTTP)}],g=e=>{if(!e)return s(n.SETTINGS$MCP_ERROR_URL_REQUIRED);try{const o=new URL(e);if(!["http:","https:"].includes(o.protocol))return s(n.SETTINGS$MCP_ERROR_URL_INVALID_PROTOCOL)}catch{return s(n.SETTINGS$MCP_ERROR_URL_INVALID)}return null},b=e=>e?/^[a-zA-Z0-9_-]+$/.test(e)?null:s(n.SETTINGS$MCP_ERROR_NAME_INVALID):s(n.SETTINGS$MCP_ERROR_NAME_REQUIRED),h=e=>!a||!(c==="add"||c==="edit"&&d?.name!==e)?null:a.filter(_=>_.type==="stdio").map(_=>_.name).filter(Boolean).includes(e)?s(n.SETTINGS$MCP_ERROR_NAME_DUPLICATE):null,y=e=>e?e.includes(" ")?s(n.SETTINGS$MCP_ERROR_COMMAND_NO_SPACES):null:s(n.SETTINGS$MCP_ERROR_COMMAND_REQUIRED),I=e=>{if(!a)return null;const o=d?.url;return(c==="add"||c==="edit"&&o!==e)&&a.some(p=>(p.type==="sse"||p.type==="shttp")&&p.url===e)?s(n.SETTINGS$MCP_ERROR_URL_DUPLICATE):null},w=e=>{if(!e.trim())return null;const o=e.split(`
`);for(let S=0;S<o.length;S+=1){const _=o[S].trim();if(_){const p=_.indexOf("=");if(p===-1)return s(n.SETTINGS$MCP_ERROR_ENV_INVALID_FORMAT);if(!_.substring(0,p).trim())return s(n.SETTINGS$MCP_ERROR_ENV_INVALID_FORMAT)}}return null},O=e=>{if(!e.trim())return null;const o=parseInt(e.trim(),10);return Number.isNaN(o)?s(n.SETTINGS$MCP_ERROR_TIMEOUT_INVALID_NUMBER):o<=0?s(n.SETTINGS$MCP_ERROR_TIMEOUT_POSITIVE):o>3600?s(n.SETTINGS$MCP_ERROR_TIMEOUT_MAX_EXCEEDED):null},$=e=>{const o=e.get("name")?.toString().trim()||"",S=e.get("command")?.toString().trim()||"",_=e.get("env")?.toString()||"",p=b(o);if(p)return p;const f=h(o);if(f)return f;const N=y(S);if(N)return N;const T=w(_);return T||null},D=e=>{if(r==="sse"||r==="shttp"){const o=e.get("url")?.toString().trim()||"",S=g(o);if(S)return S;const _=I(o);if(_)return _;if(r==="shttp"){const p=e.get("timeout")?.toString()||"",f=O(p);if(f)return f}return null}return r==="stdio"?$(e):null},G=e=>{const o={},S=e.trim();if(!S)return o;for(const _ of S.split(`
`)){const p=_.trim(),f=p.indexOf("="),N=f>=0?p.substring(0,f).trim():"";p&&f!==-1&&N&&(o[N]=p.substring(f+1).trim())}return o},A=e=>e?Object.entries(e).map(([o,S])=>`${o}=${S}`).join(`
`):"",V=e=>{e.preventDefault(),x(null);const o=new FormData(e.currentTarget),S=D(o);if(S){x(S);return}const _={id:d?.id||`${r}-${Date.now()}`,type:r};if(r==="sse"||r==="shttp"){const p=o.get("url")?.toString().trim(),f=o.get("api_key")?.toString().trim(),N=o.get("timeout")?.toString().trim(),T={..._,url:p,...f&&{api_key:f}};if(r==="shttp"&&N){const C=parseInt(N,10);Number.isNaN(C)||(T.timeout=C)}i(T)}else if(r==="stdio"){const p=o.get("name")?.toString().trim(),f=o.get("command")?.toString().trim(),N=o.get("args")?.toString().trim(),T=o.get("env")?.toString().trim(),C=N?N.split(`
`).map(z=>z.trim()).filter(Boolean):[],Y=G(T||"");i({..._,name:p,command:f,...C.length>0&&{args:C},...Object.keys(Y).length>0&&{env:Y}})}},l=c==="add"?"add-mcp-server-form":"edit-mcp-server-form";return t.jsxs("form",{"data-testid":l,onSubmit:V,className:"flex flex-col items-start gap-6",children:[c==="add"&&t.jsx(J,{testId:"server-type-dropdown",name:"server-type",label:s(n.SETTINGS$MCP_SERVER_TYPE),items:v,selectedKey:r,onSelectionChange:e=>E(e),onInputChange:()=>{},isClearable:!1,allowsCustomValue:!1,required:!0,wrapperClassName:k("w-full","max-w-[680px]")}),m&&t.jsx("p",{className:"text-red-500 text-sm",children:m}),(r==="sse"||r==="shttp")&&t.jsxs(t.Fragment,{children:[t.jsx(R,{testId:"url-input",name:"url",type:"url",label:s(n.SETTINGS$MCP_URL),className:"w-full max-w-[680px]",required:!0,defaultValue:d?.url||"",placeholder:"https://api.example.com"}),t.jsx(R,{testId:"api-key-input",name:"api_key",type:"password",label:s(n.SETTINGS$MCP_API_KEY),className:"w-full max-w-[680px]",showOptionalTag:!0,defaultValue:d?.api_key||"",placeholder:s(n.SETTINGS$MCP_API_KEY_PLACEHOLDER)}),r==="shttp"&&t.jsx(R,{testId:"timeout-input",name:"timeout",type:"number",label:"Timeout (seconds)",className:"w-full max-w-[680px]",showOptionalTag:!0,defaultValue:d?.timeout?.toString()||"",placeholder:"60",min:1,max:3600})]}),r==="stdio"&&t.jsxs(t.Fragment,{children:[t.jsx(R,{testId:"name-input",name:"name",type:"text",label:s(n.SETTINGS$MCP_NAME),className:"w-full max-w-[680px]",required:!0,defaultValue:d?.name||"",placeholder:"my-mcp-server",pattern:"^[a-zA-Z0-9_-]+$"}),t.jsx(R,{testId:"command-input",name:"command",type:"text",label:s(n.SETTINGS$MCP_COMMAND),className:"w-full max-w-[680px]",required:!0,defaultValue:d?.command||"",placeholder:"npx"}),t.jsxs("label",{className:"flex flex-col gap-2.5 w-full max-w-[680px]",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm",children:s(n.SETTINGS$MCP_COMMAND_ARGUMENTS)}),t.jsx(B,{})]}),t.jsx("textarea",{"data-testid":"args-input",name:"args",rows:3,defaultValue:d?.args?.join(`
`)||"",placeholder:`arg1
arg2
arg3`,className:k("bg-tertiary border border-[#717888] w-full rounded-sm p-2 placeholder:italic placeholder:text-tertiary-alt resize-none","disabled:bg-[#2D2F36] disabled:border-[#2D2F36] disabled:cursor-not-allowed")}),t.jsx("p",{className:"text-xs text-tertiary-alt",children:s(n.SETTINGS$MCP_COMMAND_ARGUMENTS_HELP)})]}),t.jsxs("label",{className:"flex flex-col gap-2.5 w-full max-w-[680px]",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm",children:s(n.SETTINGS$MCP_ENVIRONMENT_VARIABLES)}),t.jsx(B,{})]}),t.jsx("textarea",{"data-testid":"env-input",name:"env",rows:4,defaultValue:A(d?.env),placeholder:`KEY1=value1
KEY2=value2`,className:k("resize-none","bg-tertiary border border-[#717888] rounded-sm p-2 placeholder:italic placeholder:text-tertiary-alt","disabled:bg-[#2D2F36] disabled:border-[#2D2F36] disabled:cursor-not-allowed")})]})]}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx(U,{testId:"cancel-button",type:"button",variant:"secondary",onClick:u,children:s(n.BUTTON$CANCEL)}),t.jsxs(U,{testId:"submit-button",type:"submit",variant:"primary",children:[c==="add"&&s(n.SETTINGS$MCP_ADD_SERVER),c==="edit"&&s(n.SETTINGS$MCP_SAVE_SERVER)]})]})]})}function it(){const{t:c}=P(),{data:d,isLoading:a}=j(),{mutate:i}=tt(),{mutate:u}=et(),{mutate:s}=st(),[r,E]=M.useState("list"),[m,x]=M.useState(null),[v,g]=M.useState(!1),[b,h]=M.useState(null),y=d?.MCP_CONFIG||{sse_servers:[],stdio_servers:[],shttp_servers:[]},I=[...y.sse_servers.map((l,e)=>({id:`sse-${e}`,type:"sse",url:typeof l=="string"?l:l.url,api_key:typeof l=="object"?l.api_key:void 0})),...y.stdio_servers.map((l,e)=>({id:`stdio-${e}`,type:"stdio",name:l.name,command:l.command,args:l.args,env:l.env})),...y.shttp_servers.map((l,e)=>({id:`shttp-${e}`,type:"shttp",url:typeof l=="string"?l:l.url,api_key:typeof l=="object"?l.api_key:void 0,timeout:typeof l=="object"?l.timeout:void 0}))],w=l=>{u(l,{onSuccess:()=>{E("list")}})},O=l=>{s({serverId:l.id,server:l},{onSuccess:()=>{E("list")}})},$=l=>{i(l,{onSuccess:()=>{g(!1)}})},D=l=>{x(l),E("edit")},G=l=>{h(l),g(!0)},A=()=>{b&&($(b),h(null))},V=()=>{g(!1),h(null)};return a?t.jsx("div",{className:"flex flex-col gap-5",children:t.jsxs("div",{className:"animate-pulse",children:[t.jsx("div",{className:"h-6 bg-gray-300 rounded w-1/4 mb-4"}),t.jsx("div",{className:"h-4 bg-gray-300 rounded w-1/2 mb-8"}),t.jsx("div",{className:"h-10 bg-gray-300 rounded w-32"})]})}):t.jsxs("div",{className:"flex flex-col gap-5",children:[r==="list"&&t.jsxs(t.Fragment,{children:[t.jsx(U,{testId:"add-mcp-server-button",type:"button",variant:"primary",onClick:()=>E("add"),isDisabled:a,children:c(n.SETTINGS$MCP_ADD_SERVER)}),t.jsx(rt,{servers:I,onEdit:D,onDelete:G})]}),r==="add"&&t.jsx(Q,{mode:"add",existingServers:I,onSubmit:w,onCancel:()=>E("list")}),r==="edit"&&m&&t.jsx(Q,{mode:"edit",server:m,existingServers:I,onSubmit:O,onCancel:()=>{E("list"),x(null)}}),v&&t.jsx(W,{text:c(n.SETTINGS$MCP_CONFIRM_DELETE),onConfirm:A,onCancel:V})]})}const bt=H(it);export{bt as default};
