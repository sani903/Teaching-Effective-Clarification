import{R as E,p as e,w as O}from"./chunk-NISHYRIK-CgksP-ke.js";import{u as A}from"./open-hands-axios-DsgPCc-0.js";import{u as _,a as L}from"./use-config-BtaDlBUv.js";import{S as j}from"./secrets-service-C30Wl9UY.js";import{u as M}from"./use-is-authed-CJdzFdqm.js";import{u as v,B as D}from"./brand-button-BLaTuvKj.js";import{I as u}from"./declaration-BLNM_M5s.js";import{S as k}from"./settings-input-Blv1eH9r.js";import{c as R}from"./utils-C5iw9p3M.js";import{O as q}from"./optional-tag-C2att6n-.js";import{u as $}from"./useTranslation-BhtO8iYN.js";import{e as U,f as P}from"./index-CQq-b-9n.js";import{C as Q}from"./confirmation-modal-LYfE9har.js";import"./option-service.api-L97_35Hu.js";import"./modal-backdrop-CfHRd2ER.js";const F=()=>{const{data:t}=_(),{data:s}=M(),a=t?.APP_MODE==="oss";return L({queryKey:["secrets"],queryFn:j.getSecrets,enabled:a||s})},K=()=>v({mutationFn:t=>j.deleteSecret(t)}),V=()=>v({mutationFn:({name:t,value:s,description:a})=>j.createSecret(t,s,a)}),z=()=>v({mutationFn:({secretToEdit:t,name:s,description:a})=>j.updateSecret(t,s,a)});function B({mode:t,selectedSecret:s,onCancel:a}){const d=A(),{t:o}=$(),{data:c}=F(),{mutate:p}=V(),{mutate:x}=z(),[f,S]=E.useState(null),h=t==="edit"&&s&&c?.find(r=>r.name===s)?.description?.trim()||"",N=(r,i,l)=>{p({name:r,value:i,description:l},{onSettled:a,onSuccess:async()=>{await d.invalidateQueries({queryKey:["secrets"]})}})},y=(r,i,l)=>{d.setQueryData(["secrets"],b=>b?b.map(m=>m.name===r?{...m,name:i,description:l}:m):[])},w=()=>{d.invalidateQueries({queryKey:["secrets"]})},C=(r,i,l)=>{y(r,i,l),x({secretToEdit:r,name:i,description:l},{onSettled:a,onError:w})},g=r=>{r.preventDefault();const i=new FormData(r.currentTarget),l=i.get("secret-name")?.toString(),b=i.get("secret-value")?.toString().trim(),m=i.get("secret-description")?.toString();if(l){if(S(null),c?.some(I=>I.name===l&&I.name!==s)){S(o("SECRETS$SECRET_ALREADY_EXISTS"));return}if(t==="add"){if(!b){S(o("SECRETS$SECRET_VALUE_REQUIRED"));return}N(l,b,m||void 0)}else t==="edit"&&s&&C(s,l,m||void 0)}},n=t==="add"?"add-secret-form":"edit-secret-form";return e.jsxs("form",{"data-testid":n,onSubmit:g,className:"flex flex-col items-start gap-6",children:[e.jsx(k,{testId:"name-input",name:"secret-name",type:"text",label:"Name",className:"w-full max-w-[350px]",required:!0,defaultValue:t==="edit"&&s?s:"",placeholder:o("SECRETS$API_KEY_EXAMPLE"),pattern:"^\\S*$"}),f&&e.jsx("p",{className:"text-red-500 text-sm",children:f}),t==="add"&&e.jsxs("label",{className:"flex flex-col gap-2.5 w-full max-w-[680px]",children:[e.jsx("span",{className:"text-sm",children:o(u.FORM$VALUE)}),e.jsx("textarea",{"data-testid":"value-input",name:"secret-value",required:!0,className:R("resize-none","bg-tertiary border border-[#717888] rounded-sm p-2 placeholder:italic placeholder:text-tertiary-alt","disabled:bg-[#2D2F36] disabled:border-[#2D2F36] disabled:cursor-not-allowed"),rows:8})]}),e.jsxs("label",{className:"flex flex-col gap-2.5 w-full max-w-[680px]",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm",children:o(u.FORM$DESCRIPTION)}),e.jsx(q,{})]}),e.jsx("input",{"data-testid":"description-input",name:"secret-description",defaultValue:h,className:R("resize-none","bg-tertiary border border-[#717888] rounded-sm p-2 placeholder:italic placeholder:text-tertiary-alt","disabled:bg-[#2D2F36] disabled:border-[#2D2F36] disabled:cursor-not-allowed")})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(D,{testId:"cancel-button",type:"button",variant:"secondary",onClick:a,children:o(u.BUTTON$CANCEL)}),e.jsxs(D,{testId:"submit-button",type:"submit",variant:"primary",children:[t==="add"&&o("SECRETS$ADD_SECRET"),t==="edit"&&o("SECRETS$EDIT_SECRET")]})]})]})}function T(){return e.jsxs("div",{className:"border-t border-[#717888] last-of-type:border-b max-w-[830px] pr-2.5 py-[13px] flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center justify-between w-1/3",children:[e.jsx("span",{className:"skeleton h-4 w-1/2"}),e.jsx("span",{className:"skeleton h-4 w-1/4"})]}),e.jsxs("div",{className:"flex items-center gap-8",children:[e.jsx("span",{className:"skeleton h-4 w-4"}),e.jsx("span",{className:"skeleton h-4 w-4"})]})]})}function G({title:t,description:s,onEdit:a,onDelete:d}){return e.jsxs("tr",{"data-testid":"secret-item",className:"flex w-full items-center border-t border-tertiary",children:[e.jsx("td",{className:"p-3 w-1/4 text-sm text-content-2 truncate",title:t,children:t}),e.jsx("td",{className:"p-3 w-1/2 truncate overflow-hidden whitespace-nowrap text-sm text-content-2 opacity-80 italic",title:s||"",children:s||""}),e.jsxs("td",{className:"p-3 w-1/4 flex items-center justify-end gap-4",children:[e.jsx("button",{"data-testid":"edit-secret-button",type:"button",onClick:a,"aria-label":`Edit ${t}`,className:"cursor-pointer",children:e.jsx(U,{size:16})}),e.jsx("button",{"data-testid":"delete-secret-button",type:"button",onClick:d,"aria-label":`Delete ${t}`,className:"cursor-pointer",children:e.jsx(P,{size:16})})]})]})}function Y(){const t=A(),{t:s}=$(),{data:a,isLoading:d}=F(),{mutate:o}=K(),[c,p]=E.useState("list"),[x,f]=E.useState(null),[S,h]=E.useState(!1),N=n=>{t.setQueryData(["secrets"],r=>r?r.filter(i=>i.name!==n):[])},y=()=>{t.invalidateQueries({queryKey:["secrets"]})},w=n=>{N(n),o(n,{onSettled:()=>{h(!1)},onError:y})},C=()=>{x&&w(x)},g=()=>{h(!1)};return e.jsxs("div",{"data-testid":"secrets-settings-screen",className:"flex flex-col gap-5",children:[d&&c==="list"&&e.jsxs("ul",{children:[e.jsx(T,{}),e.jsx(T,{}),e.jsx(T,{})]}),c==="list"&&e.jsx(D,{testId:"add-secret-button",type:"button",variant:"primary",onClick:()=>p("add-secret-form"),isDisabled:d,children:s("SECRETS$ADD_NEW_SECRET")}),c==="list"&&e.jsx("div",{className:"border border-tertiary rounded-md overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-base-tertiary",children:e.jsxs("tr",{className:"flex w-full items-center",children:[e.jsx("th",{className:"w-1/4 text-left p-3 text-sm font-medium",children:s(u.SETTINGS$NAME)}),e.jsx("th",{className:"w-1/2 text-left p-3 text-sm font-medium",children:s(u.SECRETS$DESCRIPTION)}),e.jsx("th",{className:"w-1/4 text-right p-3 text-sm font-medium",children:s(u.SETTINGS$ACTIONS)})]})}),e.jsx("tbody",{children:a?.map(n=>e.jsx(G,{title:n.name,description:n.description,onEdit:()=>{p("edit-secret-form"),f(n.name)},onDelete:()=>{h(!0),f(n.name)}},n.name))})]})}),(c==="add-secret-form"||c==="edit-secret-form")&&e.jsx(B,{mode:c==="add-secret-form"?"add":"edit",selectedSecret:x,onCancel:()=>p("list")}),S&&e.jsx(Q,{text:s("SECRETS$CONFIRM_DELETE_KEY"),onConfirm:C,onCancel:g})]})}const me=O(Y);export{me as default};
